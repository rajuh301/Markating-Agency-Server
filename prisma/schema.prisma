generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String          @id @default(uuid())
  email            String          @unique
  password         String?
  fullName         String
  avatarUrl        String?
  phoneNumber      String?
  googleId         String?         @unique
  appleId          String?         @unique
  role             UserRole        @default(MEMBER)
  organizationId   String
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  organization     Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  verificationCode String?
  codeExpiry       DateTime?

  // --- Relations ---
  projectMembers   ProjectMember[] 
  createdProjects  Project[]       @relation("CreatedBy")
}

model Organization {
  id            String   @id @default(uuid())
  name          String
  slug          String   @unique
  logoUrl       String?  
  phoneNumber   String?
  website       String?
  address       String?
  city          String?
  country       String?
  taxId         String?  
  currency      String   @default("USD")
  timezone      String   @default("UTC")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Opposite relations (Fixes P1012)
  users         User[]
  clients       Client[]
  expenses      Expense[]
  invoices      Invoice[]
  leads         Lead[]
  projects      Project[]
  subscription  Subscription?
}

model Plan {
  id                String         @id @default(uuid())
  name              String
  description       String?
  monthlyPrice      Decimal        @db.Decimal(10, 2)
  annualPrice       Decimal        @db.Decimal(10, 2)
  userLimit         Int            @default(1)
  projectLimit      Int            @default(5)
  storageLimit      Int            @default(5)
  canCustomBranding Boolean        @default(false)
  subscriptions     Subscription[]
}

model Subscription {
  id                String             @id @default(uuid())
  status            SubscriptionStatus @default(TRIALING)
  billingCycle      BillingCycle
  startDate         DateTime           @default(now())
  currentPeriodEnd  DateTime
  cancelAtPeriodEnd Boolean            @default(false)
  organizationId    String             @unique
  planId            String
  organization      Organization       @relation(fields: [organizationId], references: [id])
  plan              Plan               @relation(fields: [planId], references: [id])
  transactions      Transaction[]
}

model Transaction {
  id             String        @id @default(uuid())
  amount         Decimal       @db.Decimal(10, 2)
  currency       String        @default("USD")
  status         PaymentStatus
  provider       String
  providerRef    String        @unique
  subscriptionId String
  createdAt      DateTime      @default(now())
  subscription   Subscription  @relation(fields: [subscriptionId], references: [id])
}

model Client {
  id              String       @id @default(uuid())
  companyName     String?      
  email           String       
  website         String?      
  address         String?      
  country         String?      
  city            String?      
  notes           String?      @db.Text 
  contactPerson   String       
  phoneNumber     String       
  taxId           String?      
  organizationId  String
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoices        Invoice[]
  projects        Project[]
}

model Project {
  id             String          @id @default(uuid())
  name           String
  creatorId      String
  description    String?
  status         ProjectStatus   @default(PLANNING)
  startDate      DateTime?
  endDate        DateTime?
  budget         Decimal?        @db.Decimal(10, 2)
  clientId       String
  organizationId String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  members        ProjectMember[]
  
  creator        User            @relation("CreatedBy", fields: [creatorId], references: [id])
  client         Client          @relation(fields: [clientId], references: [id])
  organization   Organization    @relation(fields: [organizationId], references: [id])
  tasks          Task[]
}

model ProjectMember {
  id        String  @id @default(uuid())
  projectId String
  userId    String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
}

model Task {
  id          String     @id @default(uuid())
  title       String
  description String?
  priority    Priority   @default(MEDIUM)
  status      TaskStatus @default(TODO)
  projectId   String
  dueDate     DateTime?
  createdAt   DateTime   @default(now())
  project     Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Invoice {
  id             String        @id @default(uuid())
  invoiceNumber  String        @unique
  issueDate      DateTime      @default(now())
  dueDate        DateTime
  amount         Decimal       @db.Decimal(10, 2)
  status         InvoiceStatus @default(DRAFT)
  clientId       String
  organizationId String
  client         Client        @relation(fields: [clientId], references: [id])
  organization   Organization  @relation(fields: [organizationId], references: [id])
}

model Lead {
  id             String       @id @default(uuid())
  fullName       String
  email          String
  source         String?
  status         String       @default("New")
  organizationId String
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id])
}

model Expense {
  id             String       @id @default(uuid())
  title          String
  amount         Decimal      @db.Decimal(10, 2)
  category       String
  date           DateTime     @default(now())
  description    String?
  organizationId String
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

enum UserRole {
  OWNER
  ADMIN
  MEMBER
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
}

enum BillingCycle {
  MONTHLY
  ANNUAL
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum ProjectStatus {
  PLANNING
  ACTIVE
  COMPLETED
  ON_HOLD
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  REVIEW
  DONE
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}
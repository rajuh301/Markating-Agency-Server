generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String        @id @default(uuid())
  email            String        @unique
  password         String?
  fullName         String
  avatarUrl        String?
  phoneNumber      String?
  googleId         String?       @unique
  appleId          String?       @unique
  role             UserRole      @default(MEMBER)
  roles            UserRoleMap[]
  organizationId   String
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  organization     Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  verificationCode String?
  codeExpiry       DateTime?

  // --- Relations ---
  status          UserStatus      @default(PENDING)
  projectMembers  ProjectMember[]
  createdProjects Project[]       @relation("CreatedBy")
  managedProjects Project[]       @relation("ProjectManager")
}

model Organization {
  id           String        @id @default(uuid())
  name         String
  slug         String        @unique
  logoUrl      String?
  phoneNumber  String?
  website      String?
  address      String?
  city         String?
  country      String?
  taxId        String?
  currency     String        @default("USD")
  timezone     String        @default("UTC")
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  status       String        @default("ACTIVE")
  roles        Role[]
  users        User[]
  clients      Client[]
  expenses     Expense[]
  invoices     Invoice[]
  leads        Lead[]
  projects     Project[]
  reports      Report[]
  subscription Subscription?
  Quotation    Quotation[]
}

model Report {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  totalRevenue      Float @default(0)
  totalExpense      Float @default(0)
  activeProjects    Int   @default(0)
  completedProjects Int   @default(0)
  totalClients      Int   @default(0)

  month     String
  year      Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, month, year])
}

model Plan {
  id                String         @id @default(uuid())
  name              String
  description       String?
  monthlyPrice      Decimal        @db.Decimal(10, 2)
  annualPrice       Decimal        @db.Decimal(10, 2)
  userLimit         Int            @default(1)
  projectLimit      Int            @default(5)
  storageLimit      Int            @default(5)
  canCustomBranding Boolean        @default(false)
  subscriptions     Subscription[]
}

model Subscription {
  id                String             @id @default(uuid())
  status            SubscriptionStatus @default(TRIALING)
  billingCycle      BillingCycle
  startDate         DateTime           @default(now())
  currentPeriodEnd  DateTime
  cancelAtPeriodEnd Boolean            @default(false)
  organizationId    String             @unique
  planId            String
  organization      Organization       @relation(fields: [organizationId], references: [id])
  plan              Plan               @relation(fields: [planId], references: [id])
  transactions      Transaction[]
}

model Transaction {
  id             String        @id @default(uuid())
  amount         Decimal       @db.Decimal(10, 2)
  currency       String        @default("USD")
  status         PaymentStatus
  provider       String
  providerRef    String        @unique
  subscriptionId String
  createdAt      DateTime      @default(now())
  subscription   Subscription  @relation(fields: [subscriptionId], references: [id])
}

model Client {
  id             String       @id @default(uuid())
  companyName    String?
  email          String
  website        String?
  address        String?
  country        String?
  city           String?
  notes          String?      @db.Text
  contactPerson  String
  phoneNumber    String
  taxId          String?
  organizationId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  status         String       @default("ACTIVE")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoices       Invoice[]
  projects       Project[]
  quotations     Quotation[]
}

model Project {
  id          String        @id @default(uuid())
  name        String
  description String?
  status      ProjectStatus @default(PLANNING)

  budget       Decimal? @db.Decimal(10, 2)
  currency     String?  @default("USD")
  billingType  String? // Fixed Price, Hourly, etc.
  paymentTerms String? // NET 30%, etc.

  startDate DateTime?
  deadline  DateTime?
  endDate   DateTime?

  organizationId   String
  clientId         String
  projectManagerId String?
  creatorId        String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  creator      User         @relation("CreatedBy", fields: [creatorId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])
  client       Client       @relation(fields: [clientId], references: [id])

  projectManager User? @relation("ProjectManager", fields: [projectManagerId], references: [id])

  members ProjectMember[]
  tasks   Task[]
  Invoice Invoice[]
}

model ProjectMember {
  id        String  @id @default(uuid())
  projectId String
  userId    String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
}

model Task {
  id          String     @id @default(uuid())
  title       String
  description String?
  priority    Priority   @default(MEDIUM)
  status      TaskStatus @default(TODO)
  projectId   String
  dueDate     DateTime?
  createdAt   DateTime   @default(now())
  project     Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Invoice {
  id            String  @id @default(uuid())
  invoiceNumber String  @unique
  themeColor    String? @default("#0F06A0")
  companyLogo   String?

  currency     String   @default("USD")
  poNumber     String?
  paymentTerms String?
  issueDate    DateTime @default(now())
  dueDate      DateTime

  fromName    String?
  fromAddress String?
  fromEmail   String?
  fromPhone   String?

  toName    String?
  toAddress String?
  toEmail   String?
  toPhone   String?

  taxRate     Float   @default(0)
  amountPaid  Decimal @default(0) @db.Decimal(10, 2)
  subTotal    Decimal @db.Decimal(10, 2)
  totalAmount Decimal @db.Decimal(10, 2)

  notes     String?
  terms     String?
  signature String?
  status    InvoiceStatus @default(DRAFT)

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id])

  clientId String?
  client   Client? @relation(fields: [clientId], references: [id])

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  items     InvoiceItem[]
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}

model InvoiceItem {
  id          String  @id @default(uuid())
  description String
  quantity    Int     @default(1)
  rate        Decimal @db.Decimal(10, 2)
  amount      Decimal @db.Decimal(10, 2)

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

model Lead {
  id             String       @id @default(uuid())
  fullName       String
  email          String
  source         String?
  status         String       @default("New")
  organizationId String
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id])
}

model Expense {
  id             String       @id @default(uuid())
  title          String
  amount         Decimal      @db.Decimal(10, 2)
  category       String
  date           DateTime     @default(now())
  description    String?
  organizationId String
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

model Quotation {
  id              String  @id @default(uuid())
  quotationNumber String  @unique
  themeColor      String? @default("#0F06A0")
  companyLogo     String?

  currency      String   @default("USD ($)")
  poNumber      String?
  paymentTerms  String?
  quotationDate DateTime @default(now())
  dueDate       DateTime

  fromName    String?
  fromAddress String?
  fromEmail   String?
  fromPhone   String?

  toName    String?
  toAddress String?
  toEmail   String?
  toPhone   String?

  taxRate     Float   @default(0)
  subTotal    Decimal @db.Decimal(10, 2)
  totalAmount Decimal @db.Decimal(10, 2)

  notes     String?
  terms     String?
  signature String?
  status    QuotationStatus @default(PENDING)

  clientId       String
  organizationId String
  client         Client       @relation(fields: [clientId], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id])

  items     QuotationItem[]
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
}

model QuotationItem {
  id          String  @id @default(uuid())
  description String
  quantity    Int
  rate        Decimal @db.Decimal(10, 2)
  amount      Decimal @db.Decimal(10, 2)

  quotationId String
  quotation   Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
}

model Role {
  id             String        @id @default(uuid())
  name           String        @unique
  description    String?
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  permissions    Permission[]
  users          UserRoleMap[]
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
}

model Permission {
  id        String  @id @default(uuid())
  module    String
  canView   Boolean @default(false)
  canCreate Boolean @default(false)
  canEdit   Boolean @default(false)
  canDelete Boolean @default(false)
  roleId    String
  role      Role    @relation(fields: [roleId], references: [id], onDelete: Cascade)
}

model UserRoleMap {
  id     String @id @default(uuid())
  userId String
  roleId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
}

enum QuotationStatus {
  PENDING
  SENT
  ACCEPTED
  DECLINED
  INVOICED
}

enum UserRole {
  OWNER
  ADMIN
  MEMBER
  PROJECT_MANAGER
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
}

enum BillingCycle {
  MONTHLY
  ANNUAL
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum ProjectStatus {
  PLANNING
  ACTIVE
  COMPLETED
  ON_HOLD
  CANCELLED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  REVIEW
  DONE
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum UserStatus {
  ACTIVE
  INACTIVE
  PENDING
}
